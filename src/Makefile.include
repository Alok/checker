include src/tactics/Makefile.include

SRCFILES =					\
	src/positions.ml			\
	src/error.ml				\
	src/variables.ml			\
	src/expressions.ml			\
	src/typesystem.ml			\
	src/names.ml				\
	src/helpers.ml				\
	src/printer.ml				\
	src/hash.ml				\
	src/universe.ml				\
	src/alpha.ml src/alpha.mli		\
	src/substitute.ml			\
	src/tau.ml src/tau.mli			\
	src/errorcheck.ml			\
	src/lfcheck.ml				\
	src/toplevel.ml				\
	src/parse.ml src/grammar.mly		\
	src/tokens.mll				\
	src/checker.ml				\
	$(TACTIC_FILES)

CODE = byte
# A convenient way to select native code on the command line is:
#    make CODE=native
# A convenient way to select native code without changing the makefile or the command line is:
#    export MAKEFLAGS=" CODE=native "

CHECKER_EXE = checker.$(CODE)

ifeq ($(CODE),byte)
# -b indicates a backtrace should be printed for an uncaught exception:
CHECKER_ENV = OCAMLRUNPARAM=-b
endif
# add ,p to get the ocamlyacc parser to display a trace
# CHECKER_ENV += ,p

CHECKER_OPTIONS =

DEBUG = no
ifeq "$(DEBUG)" "yes"
CHECKER_OPTIONS += --debug
endif

CHECKER := $(CHECKER_ENV) time ./$(CHECKER_EXE) $(CHECKER_OPTIONS)

# 8 below refers to Warning 8: this pattern-matching is not exhaustive.
OCFLAGS = -g,-annot,-w,@8
COMMON_BFLAGS = -I src -I src/tactics -lflags -g -yaccflag -v -menhir 'menhir --explain --error-recovery' -use-menhir 
BFLAGS        = $(COMMON_BFLAGS) -cflags $(OCFLAGS)

# this doesn't work because of a bug in ocamlbuild:
#BFLAGS_NATIVE = $(COMMON_BFLAGS) -cflags $(OCFLAGS),-S
BFLAGS_NATIVE = $(COMMON_BFLAGS) -cflags $(OCFLAGS)

# add -yaccflag --trace to ocamlbuild command line to get the menhir parser to display a trace
# BFLAGS += -yaccflag --trace

# BFLAGS += -verbose 0

BASENAMES = $(shell for i in $(patsubst %.mli, %, $(patsubst %.mly, %, $(patsubst %.mll, %, $(patsubst %.ml, %, $(SRCFILES))))) ; do echo $$i ; done | uniq)


%.cmo: %.ml; ocamlbuild $(BFLAGS) $*.cmo
%.cmo: %.mll; ocamlbuild $(BFLAGS) $*.cmo
%.cmo: %.mly; ocamlbuild $(BFLAGS) $*.cmo
%.cmx: %.ml; ocamlbuild $(BFLAGS_NATIVE) $*.cmx
%.cmx: %.mll; ocamlbuild $(BFLAGS_NATIVE) $*.cmx
%.cmx: %.mly; ocamlbuild $(BFLAGS_NATIVE) $*.cmx

all: build
build: notify src/$(CHECKER_EXE)
notify:; @ echo "make: building $(CODE) code"

# note: building checker.native will build both *.cmo and *.cmx files (???)
src/checker.native: BFLAGS = $(BFLAGS_NATIVE)
src/checker.native src/checker.byte: always; ocamlbuild $(BFLAGS) $@
always:
clean: clean_src
clean_src:; ocamlbuild -clean

all: doc
doc: checker.odocl $(SRCFILES)
	ocamlbuild $(BFLAGS) $(CHECKER_EXE) checker.docdir/index.html
checker.odocl: Makefile
	for i in $(BASENAMES) ; do echo $$i ; done >$@

clean: clean_doc
clean_doc:; rm -f TAGS checker.odocl .DS_Store

lc:; wc -l $(SRCFILES) $(RULES_FILES)

debug:
	ocamlbuild $(BFLAGS) checker.byte 
	@ echo "enter:"
	@ echo "set arg test/demo.ts"
	@ echo "goto 10000"
	@ echo "break Error.trap"
	@ echo "run"
	ocamldebug -I _build/src -I _build/src/tactics checker.byte 

# Local Variables:
# compile-command: "make -C .. build "
# End:


\documentclass[11pt]{article}
\usepackage{graphicx}
\usepackage{amscd, amssymb}
\usepackage{enumerate}
\usepackage{mathtools}          %to get \vcentcolon

\textwidth = 6.5 in
\textheight = 9 in
\oddsidemargin = 0.0 in
\evensidemargin = 0.0 in
\topmargin = 0.0 in
\headheight = 0.0 in
\headsep = 0.0 in
\parindent = 0.0in

\renewcommand{\thesubsection}{\arabic{subsection}}

\newenvironment{eq}{\begin{equation}}{\end{equation}}

\newenvironment{proof}{{\bf Proof}:}{\vskip 5mm }
\newenvironment{rem}{{\bf Remark}:}{\vskip 5mm }
\newenvironment{remarks}{{\bf Remarks}:\begin{enumerate}}{\end{enumerate}}
\newenvironment{examples}{{\bf Examples}:\begin{enumerate}}{\end{enumerate}}  

\newtheorem{proposition}{Proposition}[subsection]
\newtheorem{lemma}[proposition]{Lemma}
\newtheorem{definition}[proposition]{Definition}
\newtheorem{theorem}[proposition]{Theorem}
\newtheorem{cor}[proposition]{Corollary}
\newtheorem{conjecture}{Conjecture}
\newtheorem{pretheorem}[proposition]{Pretheorem}
\newtheorem{hypothesis}[proposition]{Hypothesis}
\newtheorem{example}[proposition]{Example}
\newtheorem{remark}[proposition]{Remark}
\newtheorem{ex}[proposition]{Exercise}
\newtheorem{cond}[proposition]{Conditions}
\newtheorem{cons}[proposition]{Construction}

%\newcommand{\C}[4]{\left[\begin{array}{rcl}&#1\\#3&\dw\dw&#4\\&#2\end{array}\right]}
\newcommand{\llabel}[1]{\label{#1}[{\bf #1}]}
%\newcommand{\llabel}[1]{\label{#1}}
\newcommand{\comment}[1]{}
\newcommand{\sr}{\rightarrow}
\newcommand{\lr}{\longrightarrow}
\newcommand{\xr}{\xrightarrow}
\newcommand{\dw}{\downarrow}
\newcommand{\bdl}{\bar{\Delta}}
\newcommand{\zz}{{\bf Z\rm}}
\newcommand{\zq}{{\bf Z}_{qfh}}
\newcommand{\nn}{{\bf N\rm}}
\newcommand{\qq}{{\bf Q\rm}}
\newcommand{\nq}{{\bf N}_{qfh}}
\newcommand{\oo}{\otimes}
\newcommand{\uu}{\underline}
\newcommand{\ih}{\uu{Hom}}
\newcommand{\af}{{\bf A}^1}
\newcommand{\wt}{\widetilde}
\newcommand{\gm}{{\bf G}_m}
\newcommand{\dsr}{\stackrel{\sr}{\scriptstyle\sr}}
%\newcommand{\PP}{$P_{\infty}$}
\newcommand{\tp}{\tilde{D}}
\newcommand{\HH}{$H_{\infty}$}
\newcommand{\ii}{\stackrel{\scriptstyle\sim}{\sr}}
\newcommand{\BB}{_{\bullet}}
\newcommand{\D}{\Delta}
\newcommand{\colim}{{\rm co}\hspace{-1mm}\lim}
\newcommand{\cf}{{\it cf} }
\newcommand{\msf}{\mathsf }
\newcommand{\mcal}{\mathcal }
\newcommand{\ep}{\epsilon}
\newcommand{\tl}{\widetilde}
\newcommand{\ub}{\mbox{\rotatebox{90}{$\in$}}}
\newcommand{\ssp}{\,\,\,\,\,\,\,\,}
\newcommand{\red}{\twoheadrightarrow}
\newcommand{\eqg}{\stackrel{\Gamma}{\approx}}
\newcommand{\alphaeq}{\stackrel{\alpha}{\sim}}
\newcommand{\rtr}{\triangleright}

\newcommand{\piece}{\vskip 3mm\noindent\refstepcounter{proposition}{\bf
\theproposition}\hspace{2mm}}
\newcommand{\subpiece}{\vskip 3mm\noindent\refstepcounter{equation}{\bf\theequation}
\hspace{2mm}}{\vskip
3mm}

%% \newcommand{\ev}{{\bf ev}}
\newcommand{\TT}{{\bf Type0}}
\newcommand{\PP}{{\bf Prop}}
\newcommand{\cc}{{\bf c}}
\newcommand{\rect}{{\bf rect}}
\newcommand{\eqd}{\stackrel{d}{=}}

\newcommand{\cu}{{u}}
\newcommand{\Eu}{{\cal U}}
\newcommand{\JJ}[2]{{J(#1,#2)\,}}
\newcommand{\J}[1]{{J(#1)\,}}
\newcommand{\jj}[3]{{j(#1,#2,#3)\,}}
\newcommand{\jr}[2]{{jr(#1, #2)\,}}
\newcommand{\jl}[2]{{jl(#1, #2)\,}}
\newcommand{\UU}[1]{{UU(#1)}}
\newcommand{\rd}{\succ}
\newcommand{\rde}{\succeq}
\newcommand{\rdA}{\rd_{\AA}}
\newcommand{\brd}{\equiv}
\newcommand{\ind}{Ind\,\,}
\newcommand{\erd}[1]{\equiv_{{\AA},#1}}
\newcommand{\spc}{{\,\,\,\,\,\,\,}}
\renewcommand{\AA}{{\cal A}}

\newcommand{\synth}{\vcentcolon\Rightarrow}
\newcommand{\force}{\Leftarrow\vcentcolon} 

\newcommand{\Type}{\mathop{{\, \sc type}}}
\newcommand{\ha}[2]{#1[#2]}
\newcommand{\Wrefl}{{\sf Wrefl}}
\newcommand{\weta}{{\sf weta}}
\newcommand{\Wtrans}{{\sf Wtrans}}
\newcommand{\Wsymm}{{\sf Wsymm}}
\newcommand{\wrefl}{{\sf wrefl}}
\newcommand{\El}{{\sf El}}
\newcommand{\annot}{{\sf annot}}
\newcommand{\conv}{{\sf conv}}
\newcommand{\ev}{{\sf ev}}
\newcommand{\wbeta}{{\sf wbeta}}
\newcommand{\weleq}{{\sf weleq}}
\newcommand{\weveq}{{\sf weveq}}
\newcommand{\wl}{{\sf wl}}
\newcommand{\wpi}{{\sf wpi}}
\newcommand{\wsymm}{{\sf wsymm}}
\newcommand{\wtrans}{{\sf wtrans}}

\begin{document}

\parskip = 2mm
\begin{center}
{\bf\Large A test type system}

{\bf Vladimir Voevodsky}

{Started January 25, 2013}  

{This version modified by Dan Grayson}  
\end{center}

\tableofcontents

This note gives some ideas about the test type system TTS with secondary
witnessed which Dan Grayson and I have been working on implementing. While TTS
by itself has (most likely) decidable definitional equality and typing making
secondary witnesses to be formally speaking unnecessary, they become essential
for the implementation of more complex systems with undecidable typing such as
HTS.

We are aiming at a type system where every derivable extended sentence can be
obtained by a unique inference rules such that one gets a bijection between
inference trees and $\alpha$-equivalence classes of derivable extended
sentences.

\subsection{Rules}

Sequences of expression of the form

$$x_1:T_1,\dots,x_n:T_n\rhd$$
$$x_1:T_1,\dots,x_n:T_n\vdash o \synth T$$
$$x_1:T_1,\dots,x_n:T_n\vdash o \force T$$
$$x_1:T_1,\dots,x_n:T_n\vdash p : T \eqd T'$$ 
$$x_1:T_1,\dots,x_n:T_n\vdash p : o \eqd o' : T$$

where $x_1,\dots,x_n$ are names of variables, $T_i$ is an expression with free
variables from $\{x_1,\dots,x_{i-1}\}$ and $o$, $o'$, $T$, $T'$ are expressions
with free variables from the set $\{x_1,\dots,x_n\}$ are called {\em sentences}
of the type system.  The terms $p$ will serve as witnesses to equalities.

Variables in the context are considered to be nameless and distinct.  To
emphasize that, we may sometimes omit the names and write just 

$$T_1,\dots,T_n\rhd$$

The sentences $\Gamma\vdash o \synth T$ and $\Gamma\vdash o \force T$ are
directional versions of the traditional sentence $\Gamma\vdash o : T$.  The
difference is that in $\Gamma\vdash o \synth T$ the type $T$ is produced from
the rest of the information in the sentence by the algorithms, whereas in
$\Gamma\vdash o \force T$ the type $T$ is known and the task is to check that
$o$ is of type $T$.  In the former case, one says that $o$ synthesizes its
type, and in the latter case, that the type of $o$ is to be checked.  We
introduce a bidirectional version of the target type theory HTS for ease of
thinking about the correctness, description, and implementation of the
algorithms.  The algorithms will necessarily be directional, in that some parts
of them will be asked to check that an object has a given type, and other parts
of which will be asked to manipulate objects whose type has already been
determined.  The final implementation of the algorithms may amount to making
the two equality judgments bidirectional, too.

{\bf Warning}: metatheoretical implications between judgments, such as $\Gamma
\vdash p : o \eqd o' : T$ implying $\Gamma \vdash o : T$ and $\Gamma \vdash T
\Type$, may not hold.

Thanks to Dan Licata for suggestions and advice.

\paragraph{General inference rules} 

\begin{enumerate}

\item 
$$\frac{}{\rhd}$$

\item For each $X\in FV$
$$\frac{\Gamma\rhd}{\Gamma\vdash X \Type}$$

Here $FV$ is a fixed set of type variables.  Here $\Gamma\vdash X \Type$
is an abbreviation for $\Gamma, x:X\rhd$ (with a fresh variable $x$).

\item 
$$\frac{\Gamma, x:T, \Gamma'\rhd}{\Gamma, x:T, \Gamma'\vdash x \synth T}$$

\item 
$$\frac{\Gamma \vdash T \Type\spc \Gamma \vdash T'\Type \spc T\sim T'}{\Gamma\vdash \ha\Wrefl{}: T\eqd T'}$$

If $T'$ is obtained from $T$ by removing conversions, it may not be possible to apply
this rule because $T'$ may not be validatable.  Similarly for objects.

\item 
$$\frac{\Gamma\vdash p:T_1\eqd T_2}{\Gamma\vdash \ha\Wsymm{p}:T_2\eqd T_1}$$

\item 
$$\frac{\Gamma\vdash p12:T_1\eqd T_2\spc\Gamma\vdash p23:T_2\eqd T_3}{\Gamma\vdash \ha\Wtrans{p12,p23,T_2}: T_1\eqd T_3}$$

\item 
$$\frac{\Gamma\vdash o \force T\spc\Gamma\vdash o' \force T \spc o \sim o'}{\Gamma\vdash \ha\wrefl{}:o\eqd o':T}$$

\item 
$$\frac{\Gamma\vdash p:o_1\eqd o_2:T}{\Gamma\vdash \ha\wsymm{p}:o_2\eqd o_1:T}$$

\item 
$$\frac{\Gamma\vdash p12:o_1\eqd o_2:T\spc\Gamma\vdash p23:o_2\eqd o_3:T}{\Gamma\vdash \ha\wtrans{p12,p23,o_2}:o_1\eqd o_3:T}$$

\item 
$$\frac{\Gamma\vdash o \synth T\spc \Gamma\vdash q : T\eqd T'}{\Gamma\vdash \ha\conv{o,q} \force T'}$$

In the comparisons $T\sim T'$ and $o\sim o':T$, the term $\ha\conv{o,T,q}$ is regarded as equivalent to $o$.

\item 
$$\frac{\Gamma\vdash o \force T}{\Gamma\vdash \ha\annot{o,T} \synth T}$$

In the code, the term $\ha\annot{o,T}$ could be represented by a private data
type, so that such terms can be created only by the kernel of the type checker,
and so no tactic could forge such a certificate.

In the comparisons $T\sim T'$ and $o\sim o':T$, the term $\ha\annot{o,T}$ is regarded as equivalent to $o$.

\end{enumerate}

\paragraph{Universe}

\begin{enumerate}

\item for $x$ not in $v(\Gamma)$

$$\frac{\Gamma\rhd}{\Gamma \vdash \Eu\Type}$$

\item for $x$ not in $v(\Gamma)$

$$\frac{\Gamma\vdash o \synth \Eu}{\Gamma \vdash \ha\El{o}\Type}$$

Later on, there will a universe level, and it will be computable from the
term $o$, hence the choice of direction in this rule.

\item 

$$\frac{\Gamma\vdash p : o \eqd o' : \Eu}{\Gamma\vdash \ha\weleq{p} : \ha\El{o} \eqd \ha\El{o'}}$$

\end{enumerate}

\paragraph{Dependent products}

\begin{enumerate}

\item 
$$\frac{\Gamma, x:T\vdash U\Type}{\Gamma\vdash \ha\prod{T,.U}\Type}$$

Here $.U$ is notation for binding a nameless variable to the scope of the expression $U$.

\item 
$$ \frac{ 
  \Gamma, T' \vdash U'  \Type      \spc 
  \Gamma     \vdash p:T \eqd T'    \spc
  \Gamma, T  \vdash q:U \eqd p^*U'
  } {
  \Gamma     \vdash \ha\wpi{p,q}:\ha\prod{T,.U}\eqd \ha\prod{T',.U'}
}$$

Here ${p}^*U'$ is notation for $U'[\ha\annot{\ha\conv{x,p},T'}/x]$,
where $U'[e/x]$ is notation for replacing the first unnamed variable in
$U'$ by $e$, and where any $x$ occuring in $e$ denotes the first unnamed variable in
the resulting term.

\item 
$$\frac{\Gamma, T\vdash o \force U}{\Gamma\vdash \ha\lambda{.o} \force \ha\prod{T,.U}}$$

Some space is saved by not annotating $\ha\lambda{.o}$ with $T$ and $.U$, due to bidirectionality.

\item 
$$\frac{\Gamma, T\vdash p : o\eqd o' : U}{\Gamma\vdash \ha\wl{p} : \ha\lambda{.o}\eqd \ha\lambda{.o'} : \ha\prod{T,.U}}$$

\item 
$$\frac{\Gamma\vdash f \synth \ha\prod{T,.U}\spc \Gamma\vdash t \force T}{\Gamma\vdash \ha\ev{f,t} \synth U[\ha\annot{t,T}]}$$

The annotation is present to ensure that the new type-expression
$U[\ha\annot{t,T}]$ remains checkable.

Here $U[o]$ is notation for replacing the first unnamed variable of
$U$ by $o$, with the second unnamed variable of $U$ becoming the first, and
so on.  Some space is saved by not annotating $\ha\ev{f,o}$ with $T$ and
$.U$, due to bidirectionality.  The same applies to such expressions as
$x.y.z.f\, x\, y\, z$, where $f$ synthesizes its type.

\item 
$$\frac{\Gamma\vdash f \synth \ha\prod{T,.U} \spc \Gamma\vdash p : f \eqd
  f' : \ha\prod{T,.U}\spc \Gamma\vdash q : t \eqd t' : T}{\Gamma\vdash
  \ha\weveq{p,q} : \ha\ev{f,t} \eqd \ha\ev{f',t'} : U[\ha\annot{t,T}]}$$

For simplicity, assume that $f'$ is $f$, and observe that $\Gamma \vdash
\ha\ev{f',t'} \force U[\ha\annot{t,T}]$ may not be valid, even though $\Gamma
\vdash \ha\ev{f',t'} \force U[\ha\annot{t',T}]$ is.  Nevertheless, $\Gamma \vdash
\ha\ev{f',t'} : U[\ha\annot{t,T}]$ is valid in the underlying type theory where
the witnesses have been forgotten.

\item 
% beta
$$\frac{ \Gamma\vdash t \force T\spc \Gamma, T\vdash u \force U}{\Gamma\vdash \ha\wbeta{T,.U} : \ha\ev{\ha\lambda{.u},t} \eqd u[\ha\annot{t,T}] : U[\ha\annot{t,T}]}$$

Replacing $\ha\lambda{.o_2}$ by
$\ha\annot{\ha\lambda{.o_2},\ha\prod{T,.U}}$ would be an alternative to
putting $T$ and $.U$ in the witness.  Comparison of two terms of the same
type by normalization need not involve computation of the types of partially
applied results, so a version of this rule free of type annotations is needed.
% eta

\item 
$$\frac{\Gamma\vdash f \force \ha\prod{T,.U}}{\Gamma\vdash \ha\weta{} : f \eqd \ha\lambda{x.\ha\ev{f,x}} : \ha\prod{T,.U}}$$ 

\end{enumerate}

\bibliography{alggeom}
\bibliographystyle{plain}
\end{document}
  %% Local Variables:
  %% compile-command: "pdflatex TTS-internal-witnesses.tex "
  %% End:
